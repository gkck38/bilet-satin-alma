# Makefile - HÄ±zlÄ± komutlar iÃ§in
# KullanÄ±m: make [komut]

.PHONY: help install start stop restart logs clean init-db test

# VarsayÄ±lan komut
help:
	@echo "ğŸ« Bilet SatÄ±n Alma Platformu - YardÄ±m"
	@echo ""
	@echo "KullanÄ±labilir komutlar:"
	@echo "  make install     - Docker image'Ä± oluÅŸtur"
	@echo "  make start       - UygulamayÄ± baÅŸlat"
	@echo "  make stop        - UygulamayÄ± durdur"
	@echo "  make restart     - UygulamayÄ± yeniden baÅŸlat"
	@echo "  make logs        - LoglarÄ± gÃ¶rÃ¼ntÃ¼le"
	@echo "  make clean       - Container'larÄ± ve volume'leri temizle"
	@echo "  make init-db     - VeritabanÄ±nÄ± sÄ±fÄ±rla ve baÅŸtan oluÅŸtur"
	@echo "  make shell       - Container'a bash ile gir"
	@echo "  make test        - Testleri Ã§alÄ±ÅŸtÄ±r"
	@echo "  make backup      - VeritabanÄ±nÄ± yedekle"
	@echo "  make restore     - VeritabanÄ±nÄ± geri yÃ¼kle"
	@echo ""

# Docker kurulumu
install:
	@echo "ğŸ“¦ Docker image oluÅŸturuluyor..."
	docker-compose build

# UygulamayÄ± baÅŸlat
start:
	@echo "ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor..."
	docker-compose up -d
	@echo "âœ… Uygulama baÅŸlatÄ±ldÄ±: http://localhost:8080"

# UygulamayÄ± durdur
stop:
	@echo "ğŸ›‘ Uygulama durduruluyor..."
	docker-compose down
	@echo "âœ… Uygulama durduruldu"

# UygulamayÄ± yeniden baÅŸlat
restart: stop start
	@echo "ğŸ”„ Uygulama yeniden baÅŸlatÄ±ldÄ±"

# LoglarÄ± gÃ¶rÃ¼ntÃ¼le
logs:
	@echo "ğŸ“‹ Loglar gÃ¶rÃ¼ntÃ¼leniyor (Ã‡Ä±kmak iÃ§in Ctrl+C)..."
	docker-compose logs -f

# Temizlik
clean:
	@echo "ğŸ§¹ Temizlik yapÄ±lÄ±yor..."
	docker-compose down -v
	rm -f database.db
	@echo "âœ… Temizlik tamamlandÄ±"

# VeritabanÄ±nÄ± baÅŸtan oluÅŸtur
init-db:
	@echo "ğŸ—„ï¸ VeritabanÄ± sÄ±fÄ±rlanÄ±yor..."
	rm -f database.db
	php init_db.php
	@echo "âœ… VeritabanÄ± oluÅŸturuldu"

# Container'a bash ile gir
shell:
	@echo "ğŸ’» Container'a baÄŸlanÄ±lÄ±yor..."
	docker exec -it bilet-platform bash

# Testleri Ã§alÄ±ÅŸtÄ±r
test:
	@echo "ğŸ§ª Testler Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
	@echo "âš ï¸ Test sistemi henÃ¼z yapÄ±landÄ±rÄ±lmadÄ±"
	# docker exec bilet-platform php vendor/bin/phpunit

# VeritabanÄ±nÄ± yedekle
backup:
	@echo "ğŸ’¾ VeritabanÄ± yedekleniyor..."
	@mkdir -p backups
	@cp database.db backups/database_$(shell date +%Y%m%d_%H%M%S).db
	@echo "âœ… Yedek oluÅŸturuldu: backups/"

# VeritabanÄ±nÄ± geri yÃ¼kle
restore:
	@echo "ğŸ“¥ VeritabanÄ± geri yÃ¼kleniyor..."
	@echo "Mevcut yedekler:"
	@ls -lh backups/
	@read -p "Hangi yedek yÃ¼klensin? (dosya adÄ±): " backup_file; \
	cp backups/$$backup_file database.db
	@echo "âœ… VeritabanÄ± geri yÃ¼klendi"

# Production build
build-prod:
	@echo "ğŸ­ Production build oluÅŸturuluyor..."
	docker-compose -f docker-compose.prod.yml build
	@echo "âœ… Production build hazÄ±r"

# GÃ¼venlik kontrolÃ¼
security-check:
	@echo "ğŸ”’ GÃ¼venlik kontrolÃ¼ yapÄ±lÄ±yor..."
	@chmod 600 database.db 2>/dev/null || echo "âš ï¸ database.db bulunamadÄ±"
	@chmod 755 . 2>/dev/null
	@echo "âœ… GÃ¼venlik kontrolÃ¼ tamamlandÄ±"

# Dosya izinlerini dÃ¼zelt
fix-permissions:
	@echo "ğŸ”§ Dosya izinleri dÃ¼zenleniyor..."
	@chmod -R 755 .
	@chmod 777 database.db 2>/dev/null || echo "âš ï¸ database.db bulunamadÄ±"
	@echo "âœ… Ä°zinler dÃ¼zenlendi"

# Composer install
composer-install:
	@echo "ğŸ“¦ Composer paketleri yÃ¼kleniyor..."
	docker exec bilet-platform composer install
	@echo "âœ… Paketler yÃ¼klendi"

# Composer update
composer-update:
	@echo "ğŸ”„ Composer paketleri gÃ¼ncelleniyor..."
	docker exec bilet-platform composer update
	@echo "âœ… Paketler gÃ¼ncellendi"

# Status kontrolÃ¼
status:
	@echo "ğŸ“Š Uygulama durumu:"
	@docker-compose ps

# TÃ¼m kurulum (temizlik + kurulum + baÅŸlatma)
fresh: clean install init-db start
	@echo "ğŸ‰ Temiz kurulum tamamlandÄ±!"
	@echo "ğŸŒ Uygulama: http://localhost:8080"
	@echo "ğŸ‘¤ Admin: admin / admin123"